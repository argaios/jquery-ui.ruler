!function(t){t.widget("ef.ruler",{options:{unit:"px",tickMajor:100,tickMinor:20,tickMicro:10,showLabel:!0,arrowStyle:"line"},_$el:null,_$container:null,_$corner:null,_$topRuler:null,_$leftRuler:null,_$topArrow:null,_$leftArrow:null,_$stage:null,_scrollTop:0,_scrollLeft:0,_scrollBarWidth:0,_unitDiv:1,_lastTopRulerPos:0,_lastLeftRulerPos:0,_units:["px","mm","cm","in"],_create:function(){var i=this;this.options.unit=this._constrainUnit(this.options.unit),this.options.tickMajor=this._constrainTick(this.options.tickMajor),this.options.tickMinor=this._constrainTick(this.options.tickMinor),this.options.tickMicro=this._constrainTick(this.options.tickMicro),this._scrollBarWidth=this._calcScrollBarWidth();var e=t(document.createElement("div")).addClass("ef-ruler"),s=t(document.createElement("div")).addClass("corner");s.appendTo(e);var o=t(document.createElement("div")).addClass("ruler").addClass("top");o.appendTo(e);var r,n;switch(this.options.arrowStyle){case"arrow":r="top-arrow",n="left-arrow";break;case"line":r="top-line",n="left-line";break;case"none":r="top-none",n="left-none"}var l=t(document.createElement("div")).addClass(r);l.appendTo(o);var a=t(document.createElement("div")).addClass("ruler").addClass("left");a.appendTo(e);var c=t(document.createElement("div")).addClass(n);c.appendTo(a);var h=t(document.createElement("div")).addClass("stage");h.appendTo(e),h.append(this.element.contents()),e.appendTo(this.element),this._$container=e,this._$corner=s,this._$topRuler=o,this._$leftRuler=a,this._$topArrow=l,this._$leftArrow=c,this._$stage=h,this.refresh(),e.scroll(function(){i._scrollTop=e.scrollTop(),i._scrollLeft=e.scrollLeft(),i._fixRulerPosition()}),this.element.mousemove(function(t){i._fixArrowsPosition(t.clientX,t.clientY)}),t(window).resize(function(){i._fixRulerSize(),i._updateRulerTicks()})},_destroy:function(){this._$container.unbind("scroll"),this.element.unbind("mousemove"),t(window).unbind("resize"),this.element.prepend(this._$stage.contents()),this._$container.remove()},_setOption:function(t,i){switch(t){case"unit":i=this._constrainUnit(i);break;case"tickMajor":case"tickMinor":case"tickMicro":i=this._constrainTick(i)}this._super(t,i)},_setOptions:function(t){this._super(t),this.refresh()},_constrainUnit:function(t){return"string"==typeof t?(t=t.toLowerCase(),this._units.every(function(i){return t===i?!1:!0})):t="px",t},_constrainTick:function(t){return isNaN(t)||0>t?0:t},_calcScrollBarWidth:function(){var i=t(document.createElement("div")).css({position:"absolute",top:"-999px",left:"-999px",width:"100px",height:"100px",overflow:"hidden"});this.element.append(i);var e=i[0].offsetWidth;i.css("overflow","scroll");var s=i[0].offsetWidth;return e==s&&(s=i[0].clientWidth),i.remove(),e-s},_calcPixelsPerMM:function(){var i=t(document.createElement("div")).css({position:"absolute",top:"-999px",left:"-999px",width:"1mm",height:"1mm"});this.element.append(i);var e=i[0].getBoundingClientRect().width;return i.remove(),e},_fixRulerPosition:function(){this._$corner.css({top:this._scrollTop,left:this._scrollLeft}),this._$topRuler.css("top",this._scrollTop),this._$leftRuler.css("left",this._scrollLeft)},_fixRulerSize:function(){var t=this._$container.width(),i=this._$container.height(),e=this._$stage.width(),s=this._$stage.height();this._$topRuler.width(e>t?e:t-this._$corner.width()-this._scrollBarWidth),this._$leftRuler.height(s>i?s:i-this._scrollBarWidth),this._updateRulerTicks()},_updateRulerTicks:function(i){i===!0&&(this._$topRuler.find(".tick").remove(),this._$leftRuler.find(".tick").remove(),this._lastTopRulerPos=this._lastLeftRulerPos=0);var e,s=null;e=this._lastTopRulerPos*this._unitDiv;for(var o=this._$topRuler.width()+100;this._lastTopRulerPos<o;)this.options.tickMajor>0&&e%this.options.tickMajor===0?(s=t(document.createElement("div")).addClass("tick").addClass("major").css("left",this._lastTopRulerPos+"px"),this.options.showLabel===!0&&s.text(e),s.appendTo(this._$topRuler)):this.options.tickMinor>0&&e%this.options.tickMinor===0?(s=t(document.createElement("div")).addClass("tick").addClass("minor").css("left",this._lastTopRulerPos+"px"),s.appendTo(this._$topRuler)):this.options.tickMicro>0&&e%this.options.tickMicro===0&&(s=t(document.createElement("div")).addClass("tick").addClass("micro").css("left",this._lastTopRulerPos+"px"),s.appendTo(this._$topRuler)),this._lastTopRulerPos+=this._unitDiv,e++;e=this._lastLeftRulerPos*this._unitDiv;for(var r=this._$leftRuler.height()+100;this._lastLeftRulerPos<r;)this.options.tickMajor>0&&e%this.options.tickMajor===0?(s=t(document.createElement("div")).addClass("tick").addClass("major").css("top",this._lastLeftRulerPos+"px"),this.options.showLabel===!0&&s.append("<span>"+e+"</span>"),s.appendTo(this._$leftRuler)):this.options.tickMinor>0&&e%this.options.tickMinor===0?(s=t(document.createElement("div")).addClass("tick").addClass("minor").css("top",this._lastLeftRulerPos+"px"),s.appendTo(this._$leftRuler)):this.options.tickMicro>0&&e%this.options.tickMicro===0&&(s=t(document.createElement("div")).addClass("tick").addClass("micro").css("top",this._lastLeftRulerPos+"px"),s.appendTo(this._$leftRuler)),this._lastLeftRulerPos+=this._unitDiv,e++},_fixArrowsPosition:function(i,e){var s=i-this.element.offset().left-this._$corner.width()-Math.round(this._$topArrow.outerWidth()/2)+parseInt(t(".ef-ruler").parents().eq(1).css("padding-left"),10),o=e-this.element.offset().top-this._$corner.height()-Math.round(this._$leftArrow.outerHeight()/2)+parseInt(t(".ef-ruler").parents().eq(1).css("padding-top"),10);this._$topArrow.css("left",s+this._scrollLeft),this._$leftArrow.css("top",o+this._scrollTop)},refresh:function(){switch(this.options.unit){case"px":this._unitDiv=1;break;case"mm":this._unitDiv=this._calcPixelsPerMM();break;case"cm":this._unitDiv=10*this._calcPixelsPerMM();break;case"in":this._unitDiv=25.4*this._calcPixelsPerMM()}this._fixRulerPosition(),this._fixRulerSize(),this._fixArrowsPosition(0,0),this._updateRulerTicks(!0)}})}(jQuery);